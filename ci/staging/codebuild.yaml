version: 0.2

env:
  variables:
    ENV: "staging"
    DOCKER_BUILDKIT: 1
    BUILDKIT_INLINE_CACHE: 1
    SECRETS_LOADER_BIN_URL: https://raw.githubusercontent.com/volunteer-delivery/secrets-loader/main/build/linux-arm64

phases:
  pre_build:
    commands:
      - >-
        curl $SECRETS_LOADER_BIN_URL -o ./secrets-loader > /dev/null;
        chmod +x ./secrets-loader;
        secrets=$(./secrets-loader get -r $AWS_REGION -p /$ENV -l deploy);
        echo "AWS_REGION: $AWS_REGION, AWS_REGION_DEFAULT: $AWS_REGION_DEFAULT";
        export $secrets > /dev/null;

      - echo $CR_PASSWORD | docker login $CR_HOST -u $CR_USERNAME --password-stdin

      - export CR_BASE="$CR_HOST/$CR_USERNAME"
      - export FRONTEND_TAG="$CR_BASE/delivery-help-frontend"
      - export BACKEND_TAG="$CR_BASE/delivery-help-backend"

      - docker pull $CR_BASE/delivery-help-node:latest || true
      - docker pull $CR_BASE/delivery-help-nginx:latest || true
      - docker pull $FRONTEND_TAG:$ENV || true
      - docker pull $FRONTEND_TAG:$ENV-builder || true
      - docker pull $BACKEND_TAG:$ENV || true
      - docker pull $BACKEND_TAG:$ENV-builder || true

  build:
    commands:
      - >
        docker build \
          --tag frontend-builder \
          --target builder \
          --file ci/$ENV/frontend/Dockerfile \
          --cache-from $FRONTEND_TAG:$ENV-builder \
          --build-arg BUILDKIT_INLINE_CACHE \
          --build-arg FRONTEND_API_URL \
          --build-arg FRONTEND_SOCKET_URL \
          --build-arg FRONTEND_ENV \
          --build-arg FRONTEND_BUGSNAG_KEY \
          .

      - >
        docker build \
          --tag frontend-app \
          --file ci/$ENV/frontend/Dockerfile \
          --cache-from frontend-builder \
          --cache-from $FRONTEND_TAG:$ENV \
          --build-arg BUILDKIT_INLINE_CACHE \
          --build-arg FRONTEND_API_URL \
          --build-arg FRONTEND_SOCKET_URL \
          --build-arg FRONTEND_ENV \
          --build-arg FRONTEND_BUGSNAG_KEY \
          .

      - >
        docker build \
          --tag backend-builder \
          --target builder \
          --file ci/$ENV/backend/Dockerfile \
          --cache-from $BACKEND_TAG:$ENV-builder \
          --build-arg BUILDKIT_INLINE_CACHE \
          .

      - >
        docker build \
          --tag backend-app \
          --file ci/$ENV/backend/Dockerfile \
          --cache-from backend-builder \
          --cache-from $BACKEND_TAG:$ENV \
          --build-arg BUILDKIT_INLINE_CACHE \
          .

  post_build:
    commands:
      - docker tag frontend-builder $FRONTEND_TAG:$ENV-builder
      - docker push $FRONTEND_TAG:$ENV-builder

      - docker tag frontend-app $FRONTEND_TAG:$ENV
      - docker push $FRONTEND_TAG:$ENV

      - docker tag backend-builder $BACKEND_TAG:$ENV-builder
      - docker push $BACKEND_TAG:$ENV-builder

      - docker tag backend-app $BACKEND_TAG:$ENV
      - docker push $BACKEND_TAG:$ENV
