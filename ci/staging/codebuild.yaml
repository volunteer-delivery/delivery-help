version: 0.2

phases:
  build:
    commands:
      - echo $CR_PASSWORD | docker login $CR_HOST -u $CR_USERNAME --password-stdin

      - export DOCKER_BUILDKIT=1
      - export FRONTEND_TAG="$CR_HOST/$CR_USERNAME/delivery-help-frontend-arm-staging:latest"
      - export BACKEND_TAG="$CR_HOST/$CR_USERNAME/delivery-help-backend-arm-staging:latest"

      - docker pull $FRONTEND_TAG || true
      - docker pull $BACKEND_TAG || true

      - >
        docker build \
          --tag $FRONTEND_TAG \
          --file ci/staging/frontend/Dockerfile \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          --build-arg FRONTEND_API_URL=$FRONTEND_API_URL \
          --build-arg FRONTEND_SOCKET_URL=$FRONTEND_SOCKET_URL \
          --build-arg FRONTEND_IP=$FRONTEND_IP \
          --build-arg FRONTEND_DOMAIN=$FRONTEND_DOMAIN \
          .

      - >
        docker build \
          --tag $BACKEND_TAG \
          --file ci/staging/backend/Dockerfile \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          .

      - docker push $FRONTEND_TAG
      - docker push $CR_HOST/$CR_USERNAME/delivery-help-backend-arm-staging:latest
