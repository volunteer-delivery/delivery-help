version: 0.2

env:
  shell: bash
  variables:
    FRONTEND_IMAGE: delivery-help-frontend-staging
    FRONTEND_TAG: $CR_HOST/$CR_USERNAME/$FRONTEND_IMAGE
    BACKEND_IMAGE: delivery-help-backend-staging
    BACKEND_TAG: $CR_HOST/$CR_USERNAME/$BACKEND_IMAGE

phases:
  install:
    commands:
      - nohup /usr/local/bin/dockerd --host=unix:///var/run/docker.sock --host=tcp://127.0.0.1:2375 --storage-driver=overlay2&
      - timeout 15 sh -c "until docker info; do echo .; sleep 1; done"

  build:
    commands:
      - echo Logging in to GitHub Registry...
      - echo $CR_PASSWORD | docker login $CR_HOST -u $CR_USERNAME --password-stdin

      - echo Building frontend...
      - >
        docker build \
          -t $FRONTEND_IMAGE:latest \
          -f deployment/staging/frontend/codebuild.Dockerfile \
          --build-arg FRONTEND_API_URL=$FRONTEND_API_URL \
          --build-arg FRONTEND_SOCKET_URL=$FRONTEND_SOCKET_URL \
          --build-arg FRONTEND_IP=$FRONTEND_IP \
          --build-arg FRONTEND_DOMAIN=$FRONTEND_DOMAIN \
          .
      - docker tag $FRONTEND_IMAGE:latest $FRONTEND_TAG:latest

      - echo Building backend...
      - >
        docker build \
          -t $BACKEND_IMAGE:latest \
          -f deployment/staging/backend/Dockerfile \
          .
      - docker tag $BACKEND_IMAGE:latest $BACKEND_TAG:latest

      - echo Pushing docker images...
      - docker push $FRONTEND_TAG:latest
      - docker push $BACKEND_TAG:latest
